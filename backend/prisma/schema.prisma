// backend/prisma/schema.prisma

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

// SQLite doesn't support enums, using String with constraints instead

model Project {
  id           String   @id @default(cuid())
  slug         String   @unique
  title        String
  shortDesc    String
  longDesc     String
  classMin     Int      // e.g., 6
  classMax     Int      // e.g., 12
  level        String // BEGINNER, INTERMEDIATE, ADVANCED
  guidance     String // FULLY_GUIDED, SEMI_GUIDED, UNGUIDED
  subjects     ProjectSubject[]
  tags         ProjectTag[]
  tools        Tool[]
  prerequisites String   // JSON string for simple list
  durationHrs  Int?
  steps        Step[]                // ordered
  submission   SubmissionSpec?
  enrollments  Enrollment[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  // Original JSON for traceability
  sourceJson   String? // JSON string
}

model Step {
  id          String  @id @default(cuid())
  projectId   String
  order       Int
  title       String
  description String
  checklist   ChecklistItem[]
  resources   Resource[]
  Project     Project @relation(fields: [projectId], references: [id])
}

model ChecklistItem {
  id        String  @id @default(cuid())
  stepId    String
  order     Int
  text      String
  Step      Step    @relation(fields: [stepId], references: [id])
}

model Resource {
  id        String @id @default(cuid())
  stepId    String
  title     String
  url       String
  type      String // video | article | dataset | notebook | code
  Step      Step   @relation(fields: [stepId], references: [id])
}

model Tool {
  id        String   @id @default(cuid())
  name      String
  Project   Project? @relation(fields: [projectId], references: [id])
  projectId String?
}

model Tag {
  id   String @id @default(cuid())
  name String @unique
  projects ProjectTag[]
}

model Subject {
  id   String @id @default(cuid())
  name String @unique
  projects ProjectSubject[]
}

model ProjectTag {
  projectId String
  tagId     String
  Project   Project @relation(fields: [projectId], references: [id])
  Tag       Tag     @relation(fields: [tagId], references: [id])
  @@id([projectId, tagId])
}

model ProjectSubject {
  projectId String
  subjectId String
  Project   Project @relation(fields: [projectId], references: [id])
  Subject   Subject @relation(fields: [subjectId], references: [id])
  @@id([projectId, subjectId])
}

model Enrollment {
  id               String         @id @default(cuid())
  projectId        String
  email            String
  name             String?
  school           String?
  classNum         Int
  userId           String?
  groupId          String?
  lastActivityAt   DateTime?
  completedAt      DateTime?
  timeSpentMinutes Int?
  createdAt        DateTime       @default(now())
  progress         EnrollmentProgress[]
  submissions      Submission[]
  activities       UserActivity[]
  project          Project        @relation(fields: [projectId], references: [id])
  user             User?          @relation(fields: [userId], references: [id])
  group            Group?         @relation(fields: [groupId], references: [id])
  @@index([userId])
  @@index([groupId])
}

model EnrollmentProgress {
  id           String  @id @default(cuid())
  enrollmentId String
  stepId       String
  checklistId  String?
  completed    Boolean @default(false)
  updatedAt    DateTime @updatedAt
  Enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])
}

model SubmissionSpec {
  id            String         @id @default(cuid())
  projectId     String  @unique
  type          String // LINK, FILE, TEXT
  instruction   String
  allowedTypes  String // JSON string for FILE: ['pdf','zip']
  Project       Project @relation(fields: [projectId], references: [id])
}

model Submission {
  id            String   @id @default(cuid())
  enrollmentId  String
  urlOrText     String   // URL to file or text content
  createdAt     DateTime @default(now())
  Enrollment    Enrollment @relation(fields: [enrollmentId], references: [id])
}

model Admin {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
}

model User {
  id               String         @id @default(cuid())
  phoneNumber      String         @unique
  email            String?
  passwordHash     String
  name             String?
  school           String?
  classNum         Int?
  createdAt        DateTime       @default(now())
  enrollments      Enrollment[]
  groups           Group[]
  activities       UserActivity[]
  createdMessages  Message[]      @relation("MessageCreator")
  receivedMessages Message[]      @relation("MessageRecipient")
  messageReads     MessageRead[]
  @@index([phoneNumber])
}

model Group {
  id                      String      @id @default(cuid())
  teamLeaderId            String
  secondMemberName        String?
  secondMemberEmail       String?
  secondMemberPhoneNumber String?
  secondMemberSchool      String?
  secondMemberClassNum    Int?
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt
  teamLeader              User        @relation(fields: [teamLeaderId], references: [id])
  enrollments             Enrollment[]
  @@index([teamLeaderId])
}

model UserActivity {
  id           String     @id @default(cuid())
  userId       String
  enrollmentId String
  activityType String     // e.g., 'view', 'step_complete', 'checklist_complete'
  metadata     String?    // JSON string for additional data
  createdAt    DateTime   @default(now())
  user         User       @relation(fields: [userId], references: [id])
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])
  @@index([userId])
  @@index([enrollmentId])
  @@index([activityType])
}

model Message {
  id          String       @id @default(cuid())
  type        String       // ANNOUNCEMENT, DIRECT, SYSTEM
  title       String
  content     String
  recipientId String?      // For DIRECT and SYSTEM messages
  createdById String?
  createdAt   DateTime     @default(now())
  createdBy   User?       @relation("MessageCreator", fields: [createdById], references: [id])
  recipient   User?        @relation("MessageRecipient", fields: [recipientId], references: [id])
  reads       MessageRead[]
  @@index([recipientId])
}

model MessageRead {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())
  Message   Message  @relation(fields: [messageId], references: [id])
  User      User     @relation(fields: [userId], references: [id])
  @@unique([messageId, userId])
  @@index([userId])
}