name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/**'
      - 'Dockerfile'
      - '.github/workflows/deploy-cloudrun.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'backend/**'
      - 'Dockerfile'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }} # e.g. developement-account
  GCP_REGION: asia-south1
  CLOUD_RUN_SERVICE: ai4kerala-project-library
  ARTIFACT_REPOSITORY: xandylearning
  ARTIFACT_REGISTRY_HOST: asia-south1-docker.pkg.dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Only run on push to main/master, not on pull requests
    if: github.event_name == 'push'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Verify gcloud authentication
        run: |
          echo "ğŸ” Verifying gcloud authentication..."
          gcloud auth list
          gcloud config list
          
      - name: Configure Docker for Artifact Registry
        run: |
          echo "ğŸ³ Configuring Docker for Artifact Registry..."
          gcloud auth configure-docker $ARTIFACT_REGISTRY_HOST --quiet

      - name: Build and push Docker image
        run: |
          # Clean up Docker system to prevent I/O errors
          echo "ğŸ§¹ Cleaning up Docker system..."
          docker system prune -f
          docker builder prune -f
          
          # Build the Docker image
          echo "ğŸ—ï¸ Building Docker image..."
          IMAGE_NAME="${ARTIFACT_REGISTRY_HOST}/${GCP_PROJECT_ID}/${ARTIFACT_REPOSITORY}/backend"
          
          docker buildx build \
            --platform=linux/amd64 \
            --no-cache \
            --progress=plain \
            -t ${IMAGE_NAME}:latest \
            -t ${IMAGE_NAME}:${{ github.sha }} \
            .
          
          # Push the image to Artifact Registry
          echo "ğŸ“¤ Pushing image to Artifact Registry..."
          docker push ${IMAGE_NAME}:latest
          docker push ${IMAGE_NAME}:${{ github.sha }}

      - name: Deploy to Cloud Run
        run: |
          echo "ğŸš€ Deploying to Cloud Run..."
          
          IMAGE_NAME="${ARTIFACT_REGISTRY_HOST}/${GCP_PROJECT_ID}/${ARTIFACT_REPOSITORY}/backend"
          
          gcloud run deploy ${CLOUD_RUN_SERVICE} \
            --image=${IMAGE_NAME}:latest \
            --region=${GCP_REGION} \
            --platform=managed \
            --allow-unauthenticated \
            --port=3000 \
            --memory=512Mi \
            --cpu=1 \
            --max-instances=1 \
            --min-instances=0 \
            

      - name: Get deployment URL
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe ${CLOUD_RUN_SERVICE} \
            --region=${GCP_REGION} \
            --format="value(status.url)")
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Your backend is now running at: ${{ steps.get-url.outputs.url }}"
          echo "ğŸ“Š You can view logs with: gcloud logs tail --service=${CLOUD_RUN_SERVICE} --region=${GCP_REGION}"


